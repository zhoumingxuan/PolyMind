from datetime import datetime
import json
import time
import uuid
from knowledge import create_webquestion_from_user,rrange_knowledge
from api_model import QwenModel, AIStream
from role import role_dissucess
from config import ConfigHelper

config = ConfigHelper()

now_date = datetime.today().strftime("%Y年%m月%d日")

MAX_EPCHO = config.get("max_epcho", 5)
ROLE_COUNT = config.get("role_count", 5)


def create_initial_solution(qwen_model: QwenModel, content, knowledge):
    """
    根据用户需求与基础知识库，生成一个“能够解决用户需求”的初步方案框架，
    供后续研究员在多轮讨论中进一步完善与讨论。
    返回值：纯文本（Markdown 风格），只描述方案本身。
    """

    system_prompt = f"""
# 任务
  1. 你需要基于用户需求构建一个解决该需求的初步方案框架。
  2. 该方案仅作为后续研究和完善的起点，不是最终结论。

# 禁止约束
  1. 绝对严格禁止产生任何“下一步计划”“后续建议”“实施步骤”等具有行动导向含义的内容。
  2. 绝对严格禁止提及实验、测试、验证、上线、部署、运行或修改代码、调用外部系统等实际操作行为。
  3. 绝对严格禁止出现与用户需求无关的内容或扩展话题。
  4. 绝对严格禁止给出确定性的最终结论，例如“已经证明……”“可以确定……”“结论是……等表述。
  5. 避免使用带有强烈指令或要求色彩的语气（如“必须”“务必”“一定要”“需要先……”等），
     更适合使用中性描述，比如“可以被设计为……”“可以被划分为……”。
  6. 绝对严格禁止与初步方案无关的任何多余表述。

# 研究局限性约束
  1. 本次研究讨论仅允许基于**公开网络资料**与**理论分析推理**展开。
  2. 在所有方案描述中，均视为**无法开展或调用**任何现实能力与外部资源，
     包括但不限于：模型调用、训练/微调、评测对比、代码执行、系统接入、数据采集或任何形式的实测验证。
  3. 因此，方案中不得写出**依赖上述能力才能成立**的具体做法或结论；
     若相关内容对理解方案必要，只能以**理论假设、概念框架或待讨论前提**的中性方式简要描述，
     不得将其写成已可验证或可直接采用的方案要点。

# 网络搜索工具说明
  1. 基础知识只能用于理解用户需求，鼓励在构建初步方案时调用网络搜索工具补充信息。
  2. 如需检索，尽量以“问题组”的形式进行设计。为支持更深入的研究，特别允许在首次检索后继续进行第二次、第三次及更多轮检索，但后续检索的问题必须在前一次网络检索基础上进一步细化、深化或缩小范围，不得重复或泛化。
  3. 每个检索问题应尽量明确时间范围、地域/主体和关键限制条件，避免语义重叠或含义重复。
  4. 严禁提出含义相同或高度等价的问题进行重复搜索。
  5. 如引用网络数据，在信息本身包含明确来源时，必须标注来源名称，时间；严禁虚构来源或捏造具体数字。
     对缺乏可靠来源支撑的细节，可以保持模糊或不写，禁止强行补全。

# 基本信息
  1. 当前日期：{now_date}
  2. 工作模式：深度研究，仅限理论研究与分析推理。
  3. 在所有表述中，都视为尚未开展任何实际业务或技术活动，你只描述一个可供讨论的方案结构。


# 方案生成目标
  1. 方案需要紧贴用户需求，以解决用户在原文中提出的问题为主要参照，不得偏离或改写用户原始诉求。
  2. 你需要围绕同一需求构建若干可能的思路或路线（至少五个），需遵循以下要求:
        a. 各思路/路线彼此不同，有不同的切入点，且各自逻辑完整、自洽。
        b. 每个思路/路线都必须是能够完整解决用户需求的详细方案，不得只解决其中一部分。
        c. 每个思路/路线必须建立在网络资料中已明确的事实基础上（如行业案例、公开数据、政策法规、实事新闻、论文结论等），并具备较高可行性。
        d. 每个思路/路线需对关键环节进行清晰、细致的描述，确保读者容易理解。
  3. 你可以根据内容需要，自主选择合适的组织方式（如小标题、分段、列表等），总体上只需让人能够大致看出：
     - 目前可能的几条主要思路或切入方向。
     - 每条思路中相对核心的环节、关注点。
     - 哪些地方明显存在不确定性、分歧空间或特别适合后续重点讨论。

# 方案来源优先级（内部生成规则）
  1. 你在“内部构建初步方案”时，需要优先复用已存在的成熟解决路径，再逐级下探到更一般化方案；仅在上层路径缺失或无法覆盖需求时，才提出创新性方案。
  2. 优先级从高到低为：
     - S1 已有专业/成熟解决方案（标准方法、行业规范、主流工程路径、权威论文/教材中稳定结论）
     - S2 行业普遍实践/通用工程方案（跨厂可复现、具有广泛共识的做法）
     - S3 大众认知下的可复现方案（常识性、低门槛、非专用领域也能理解的通用做法）
     - S4 创新/假设性方案（仅在 S1-S3 不足以覆盖时提出）

  3. 方案中禁止提到此优先级，此为内部规则，无需输出。

    """

    user_prompt = f"""
# 用户需求原文
```
{content}
```

# 用于理解需求的基础知识（仅包含理解需求所必需的定义与背景）
```
{knowledge}
```
"""

    answer, reasoning, web_content_list, references = qwen_model.do_call(
        system_prompt, user_prompt, no_search=False
    )

    solution_text = answer.strip()

    return solution_text



def summarize_and_consolidate_solutions(
    qwen_model: QwenModel,
    content: str,
    knowledge: str,
    current_solution: str,
    round_discussion: str,
    stream: AIStream | None = None,
):
    """
    第一轮讨论总结：将多个初步方案收敛为两个候选方案。
    """
    system_prompt = f"""
# 基本信息
  1. 当前日期：{now_date}。
  2. 工作模式：深度研究，仅限理论研究与分析推理。
  3. 在所有表述中，都视为尚未开展任何实际业务或技术活动。

# 任务
  1.作为本次会议主席，你的任务是在讨论结束后，对所有初步想法进行总结、提炼和收敛。
  2.你需要将讨论中出现的多个研究方案，根据讨论的反馈，整合成**两个**逻辑清晰、具有代表性的候选方案。

# 工作流程
 1.  **分析讨论内容**：理解研究员们对每个初步方案的评价、补充和质疑。
 2.  **展开数据核验**：
     由于可能存在引用错误导致结论偏差，必须严格核验讨论中涉及的数据引用：
     a. 对于研究员们赞同的方案，说明理由时引用的**每一条数据**都必须进行核对，不得遗漏。
     b. 对于研究员们提出的建议，涉及的**每一条引用数据**都必须进行核对，不得遗漏。

 3.  **争议处理**：
     如遇研究员讨论存在争议，必须严格按照以下逻辑链处理：
      a. **事实核查**：发起网络搜索，查明数据是真实还是虚构；只采纳引用数据为真实的研究员描述。
      b. **视角比对**：若争议双方数据均为真实，对比思考视角，择优选取视角更全面的一方。
      c. **深度研判**：若数据均为真实且视角均全面，发起进一步的网络搜索进行深度研究，从而判断选择哪个方向来解决争议。

 4.  **数据来源补充标记**：若核对之后发现数据来源缺少，需将相关数据来源进行补充填写。

 5.  **方案参考**： 回顾参考之前初步方案框架中提到的五个研究方案及其风格。

 6.   **方案整合与构建**：
      在执行上述步骤后，构建**两个**候选方案，必须严格遵循：
       a. **完整性**：每个方案必须能够**完整解决**用户需求，论证充分、逻辑严密，且与已确认事实一致。
       b. **细节性**：每个方案应在原始方案基础上**进一步细化与深化**，覆盖更全面的环节、条件与执行路径。
       c. **差异化**：两个方案必须**基于事实构建**（禁止虚构），且两者必须有非常明显的区别。
       d. **迭代**：充分吸收讨论中的有效建议，**从原始方案中择优整合**或**在其基础上进行修订与完善**。

 7.   **清晰呈现**：
      用细致、清晰、逻辑严密的结构描述这两个方案，以便下一轮进行对比。

# 禁止约束（Critical）
  1. **绝对禁止行动导向**：严禁产生“下一步计划”、“操作指令”、“实施步骤”等内容（如“接下来需要做…”、“首先…然后…”）。
  2. **绝对禁止实操行为**：严禁提及实验、测试、验证、上线、部署、运行代码或调用外部系统。
  3. **绝对禁止无关内容**：严禁加入与用户需求无关的话题，即使讨论中曾出现。
  4. **绝对禁止终局定论**：
     - 严禁暗示某方案是最终答案。
     - 严禁使用“已证明”、“最终结论是”等措辞。
     - 应使用“当前阶段的共识”、“目前倾向于假设”等中性描述。
  5. **语气约束**：避免强烈指令色彩（如“务必”、“必须”），使用客观陈述语气。

# 网络搜索工具说明
  1. 如需检索，尽量将检索问题成组设计（每组搜索问题数量不限），一次性或少量批量调用，避免频繁零散调用。
  2. 如需检索，尽量以“问题组”的形式进行设计。为支持更深入的研究，特别允许在首次检索后继续进行第二次、第三次及更多轮检索，但后续检索的问题必须在前一次网络检索基础上进一步细化、深化或缩小范围，不得重复或泛化。
  3. 严禁提出含义相同或高度等价的问题进行重复搜索。
  4. 如引用网络数据，在信息本身包含明确来源时，可简要标注来源名称和时间；严禁虚构来源或捏造具体数字。
     对缺乏可靠来源支撑的细节，可以保持模糊或不写，禁止强行补全。

# 输出格式
  1. 输出为一份完整的Markdown文档。
  2. 文档应包含两个明确区分的方案，例如使用“方案一”和“方案二”作为标题。
  3. 不需要解释你是如何得出这两个方案的，直接输出方案本身。
  4. 绝对不得出现与方案无关的任何描述。
"""  

    user_prompt = f"""
# 用户需求原文
```
{content}
```

# 基础知识(仅用于理解用户需求)
```
{knowledge}
```

# 初步方案框架（讨论前）
```
{current_solution}
```

# 当前讨论内容
```
{round_discussion}
```
"""
    answer, _, _, _ = qwen_model.do_call(system_prompt, user_prompt, no_search=False)
    new_solution = answer.strip()
    return new_solution


def summarize_and_select_final_plan(
    qwen_model: QwenModel,
    content: str,
    knowledge: str,
    current_solution: str,
    round_discussion: str,
    stream: AIStream | None = None,
):
    """
    第二轮（步骤一）：参考第一轮收敛风格，生成最终唯一研究方案。
    """
    system_prompt = f"""

# 基本信息
  1. 当前日期：{now_date}。
  2. 工作模式：深度研究，仅限理论研究与分析推理。
  3. 在所有表述中，都视为尚未开展任何实际业务或技术活动。

# 任务
  1. 作为本次会议主席，你需要根据"当前讨论内容"和"候选方案"进行总结、提炼与收敛，形成一份**统一的完善的研究方案**，作为后续研究的主线。
  
# 工作流程
  1. **分析讨论内容**：
     理解研究员们对两份候选方案的评价、补充与质疑，
     识别被支持的要点、被否定的要点与存在争议的要点。

  2. **梳理候选方案结构**：
     将候选方案的核心路径、关键环节与重要细节点进行拆解归并，
     明确重合部分、互补部分与冲突部分。

  3. **展开事实核验（必须检索）**：
     为避免引用错误导致结论偏差，必须严格执行网络检索核验：
     a. 凡是将要写入统一方案的**关键事实、定义、背景、常见做法或重要判断依据**，必须先通过网络检索确认其可被合理支撑。
     b. 对候选方案中被研究员引用或依赖的要点，涉及的**每一条关键事实/数据**都必须核验，不得遗漏。

  4. **争议处理**：
     如遇研究员观点冲突或证据不一致，按以下逻辑处理：
      a. **事实优先**：发起网络搜索核验相关依据，仅采纳可被检索信息支撑的描述。
      b. **视角择优**：若双方依据均可成立，择优保留更贴近用户需求且覆盖更完整的一方。
      c. **必要补强**：如仍难以判断，继续细化检索问题以澄清关键差异点。

  5. **方案整合与收敛**：
     在核验与争议处理后，将候选方案进行择优整合或合并重写，遵循：
     a. **完整性**：方案需能够完整回应用户需求，论证清晰、逻辑自洽，并与已核验事实一致。
     b. **覆盖性**：方案需对用户需求涉及的关键维度与环节做到**路径全覆盖**，包括但不限于场景、视角、适用条件、关键假设与主要限制。
     c. **细节性**：对每条路径下的重要环节与细节点进行清晰说明，避免关键步骤、关键条件或关键约束缺失。
     d. **严谨性**：充分吸收讨论中被支持的有效建议，对不可靠或无法核验的内容进行删除、弱化或替换。

  6. **一致性与遗漏检查**：
     a. 对照用户需求与候选方案清单，复核统一方案是否存在关键环节遗漏或逻辑断裂，必要时通过补充检索完善相关细节。

# 工作要点
  - 以用户需求为第一约束，保持主线统一，不扩展新方向、不引入无关设想。
  - **先检索核验，再写入方案**；任何无法得到可靠支撑的细节不得虚构或强行补全。
  - 统一方案应边界清晰、结构完整、环节具体，确保可被后续报告直接承接与展开。

# 网络搜索工具说明
  1. 如需检索，尽量将检索问题成组设计（每组搜索问题数量不限），一次性或少量批量调用，避免频繁零散调用。
  2. 如需检索，尽量以“问题组”的形式进行设计。为支持更深入的研究，特别允许在首次检索后继续进行第二次、第三次及更多轮检索，但后续检索的问题必须在前一次网络检索基础上进一步细化、深化或缩小范围，不得重复或泛化。
  3. 严禁提出含义相同或高度等价的问题进行重复搜索。
  4. 如引用网络数据，在信息本身包含明确来源时，可简要标注来源名称和时间；严禁虚构来源或捏造具体数字。
     对缺乏可靠来源支撑的细节，可以保持模糊或不写，禁止强行补全。

# 输出要求
  - 仅输出 Markdown 形式的**“统一研究方案”**文本。
  - 标题必须根据用户需求命名，禁止用类似"统一研究方案"命名。
  - 不得附加解释、过程说明或其他与研究方案无关内容。
  - 仅输出文档即可不需要附加其他内容。
"""

    user_prompt = f"""
# 用户需求原文
```
{content}
```

# 基础知识（用于理解需求）
```
{knowledge}
```

# 候选方案
```
{current_solution}
```

# 当前讨论内容
```
{round_discussion}
```
"""
    answer, _, _, _ = qwen_model.do_call(system_prompt, user_prompt, no_search=False)
    final_plan = answer.strip()

    return final_plan


def generate_report_from_plan(
    qwen_model: QwenModel,
    content: str,
    knowledge: str,
    final_plan: str,
    stream: AIStream | None = None,
):
    """
    第二轮（步骤二）：在统一研究方案基础上，生成一份结构化的研究报告初稿，
    作为后续轮次继续修订与细化的基础文本。
    """
    system_prompt = f"""

# 基本信息
  1. 当前日期：{now_date}。
  2. 工作模式：深度研究，仅限理论研究与分析推理。
  3. 在所有表述中，都视为尚未开展任何实际业务或技术活动。

# 任务
  1. 你需要基于用户需求进行理论层面的资料梳理与分析推理，形成一份结构完整、能够覆盖用户需求的研究报告。
  2. 在撰写研究报告时，必须严格围绕“研究方案”指明的具体路径与主线展开，不得改变主线或引入无关方向。

# 网络搜索工具说明
  1. 如需检索，尽量将检索问题成组设计（每组搜索问题数量不限），一次性或少量批量调用，避免频繁零散调用。
  2. 如需检索，尽量以“问题组”的形式进行设计。为支持更深入的研究，特别允许在首次检索后继续进行第二次、第三次及更多轮检索，但后续检索的问题必须在前一次网络检索基础上进一步细化、深化或缩小范围，不得重复或泛化。
  3. 严禁提出含义相同或高度等价的问题进行重复搜索。
  4. 如引用网络数据，在信息本身包含明确来源时，可简要标注来源名称和时间；严禁虚构来源或捏造具体数字。
     对缺乏可靠来源支撑的细节，可以保持模糊或不写，禁止强行补全。

# 研究报告要求
  1. 报告**最核心内容**是为用户需求，提供完整、可靠的解决方案。

  2. 报告必须严格沿“研究方案”所界定的研究方向与范围展开，基于充分的网络资料进行支撑性论证与信息整合。

  3. 报告允许出现结论性内容，但须同时满足：
     a. 结论必须以网络检索获得的关键事实依据为支撑，且信息来源清晰、可靠；
     b. 结论必须直接服务于用户需求，不得引入与需求无关的推断或延伸。

  4. 报告应覆盖用户需求涉及的关键维度与约束条件（如场景、视角、适用条件等），确保结构完整、要点不缺失。

  5. 报告仅进行理论层面的分析与表达，保持中性、研究化叙述，不预设实际落地成效或现实执行结果。

# 禁止约束
  1. 严禁出现“下一步计划”“实施步骤”“操作建议”等现实行动导向表述。
  2. 严禁描述或暗示已经开展实验、测试、部署、上线或实际业务操作。
  3. 严禁引入与用户需求无关的主题或额外案例。
  4. 严禁设置“方案/统一方案概要”等中间性章节；
  5. 严禁对来源不明的网络检索内容，强行补全。

# 输出格式
  - 直接输出一份中文 Markdown 研究报告文本。
  - 顶部需包含一个与用户需求主题密切相关的报告标题，禁止使用“研究报告”“统一方案”等过于笼统的标题。
  - 不得附加任何与报告正文无关的说明、提示或元信息。
"""
    user_prompt = f"""
# 用户需求原文
```
{content}
```

# 基础知识（用于理解需求）
```
{knowledge}
```

# 研究方案
```
{final_plan}
```

"""
    answer, _, _, _ = qwen_model.do_call(system_prompt, user_prompt, no_search=False)
    report = answer.strip()

    return report


def refine_report(
    qwen_model: QwenModel,
    content: str,
    knowledge: str,
    final_plan: str,
    current_report: str,
    round_discussion: str,
    stream: AIStream | None = None,
):
    """
    第三轮及之后（步骤一）：围绕最终研究方案修订研究报告。
    """
    system_prompt = f"""

# 基本信息
  1. 当前日期：{now_date}。
  2. 工作模式：深度研究，仅限理论研究与分析推理。
  3. 在所有表述中，都视为尚未开展任何实际业务或技术活动。

# 任务
  1. 作为会议记录员和编辑，你需要依据“最终研究方案”“当前研究报告”和“本轮讨论内容”，
     对研究报告进行**更新、修订与完善**。
  2. **“最终研究方案”为既定主线与参照，不是本步骤的修改对象**；
     你只能调整、补强或修订报告内容，保持与方案主线一致。
  3. 你的目标是让报告更完整、更严谨、更贴合用户需求与方案主线，
     不得引入与用户需求无关的新方向。

# 工作流程
  1. **对照研究方案**：
     识别本轮讨论中对方案主线的补充、修正、深化与边界澄清点，
     将其**映射到报告对应章节**进行更新与整合。

  2. **展开事实核验（必须检索）**：
     为避免引用错误或幻觉性补全导致报告偏离，必须执行网络检索核验：

     a. 凡是将要新增/强化写入报告的**关键事实、定义、背景、常见做法、重要判断依据或关键数据**，必须先通过网络检索确认其可被合理支撑。
     b. 对本轮讨论中被引用、被比较或被用作论据的**每一条关键事实/数据**，均需核验，不得遗漏。
     c. 对无法在公开资料或清晰逻辑中获得支撑的细节，**严禁作为报告结论或关键论据写入**。

  3. **争议处理**：
     如本轮讨论出现观点冲突或证据不一致，
     需通过检索与对照形成清晰、可解释的取舍：
     a. **事实优先**：发起网络搜索核验相关依据，仅采纳可被检索信息支撑的描述。
     b. **一致性优先**：若多方依据均可成立，
        优先保留**更贴近用户需求、覆盖更完整、与研究方案主线更一致**的一方。
     c. **必要补强**：如仍难以判断，继续细化检索问题，聚焦关键差异点，
        直至能够支撑报告中的表述选择。
     d. **必要取舍**：如进一步检索后仍无法明确事实依据或合理取舍，
        **则舍弃该争议点，不写入修订后的报告**。

  4. **一致性与遗漏检查**：
     a. 复核报告整体结构是否清晰、逻辑是否严密、表述是否准确。
     b. 复核报告所描述的研究路径与关键结论
        是否与“最终研究方案”保持一致；
        对重要缺口可通过补充检索进行完善。
     c. 复核报告是否能够**完整覆盖并回应**用户需求的关键问题与约束条件。

# 研究报告要求
  1. 报告**最核心内容**是为用户需求，提供完整、可靠的解决方案。

  2. 报告必须严格沿“最终研究方案”所界定的研究方向与范围展开，基于充分的网络资料进行支撑性论证与信息整合。

  3. 报告允许出现结论性内容，但须同时满足：
     a. 结论必须以网络检索获得的关键事实依据为支撑，且信息来源清晰、可靠；
     b. 结论必须直接服务于用户需求，不得引入与需求无关的推断或延伸。

  4. 报告应覆盖用户需求涉及的关键维度与约束条件（如场景、视角、适用条件等），确保结构完整、要点不缺失。

  5. 报告仅进行理论层面的分析与表达，保持中性、研究化叙述，不预设实际落地成效或现实执行结果。

# 网络搜索工具说明
  1. 如需检索，尽量将检索问题成组设计（每组搜索问题数量不限），
     一次性或少量批量调用，避免频繁零散调用。
  2. 允许在首次检索后继续进行第二次、第三次及更多轮检索，
     但后续检索的问题必须在前一次网络检索基础上进一步细化、深化或缩小范围，
     不得重复或泛化。
  3. 严禁提出含义相同或高度等价的问题进行重复搜索。
  4. 如引用网络数据，在信息本身包含明确来源时，
     可简要标注来源名称和时间；严禁虚构来源或捏造具体数字。
     对缺乏可靠来源支撑的细节，可以保持模糊或不写，禁止强行补全。

# 禁止约束
  1. 严禁出现“下一步计划”“实施步骤”“操作建议”等现实行动导向表述。
  2. 严禁描述或暗示已经开展实验、测试、部署、上线或实际业务操作。
  3. 严禁引入与用户需求无关的主题或额外案例。
  4. 对**未能通过检索明确取舍**的争议点，严禁写入修订后的研究报告。

# 输出格式
  - 直接输出修订后的中文 Markdown 研究报告正文，不附带其他说明。
"""
    
    user_prompt = f"""
# 用户需求原文
```
{content}
```

# 基础知识（用于理解需求）
```
{knowledge}
```

# 最终研究方案
```
{final_plan}
```

# 当前研究报告（修订前）
```
{current_report}
```

# 本轮讨论内容
```
{round_discussion}
```
"""
    answer, _, _, _ = qwen_model.do_call(system_prompt, user_prompt, no_search=False)
    updated_report = answer.strip()
    return updated_report


def evaluate_discussion_status(
    qwen_model: QwenModel,
    content: str,
    knowledge: str,
    final_plan: str,
    current_report: str,
    round_discussion: str,
    stream: AIStream | None = None,
):
    """
    第三轮及之后（步骤二）：判断当前讨论是否需要结束。
    """
    system_prompt = f"""
# 基本信息
  1. 当前日期：{now_date}。
  2. 工作模式：深度研究，仅限理论研究与分析推理。
  3. 你只做“讨论完备度评估”，不生成方案、不补写报告、不提出下一步。

# 评估目标
  1. 你的判断标准是：当前讨论是否已围绕用户需求形成**足够完整、无重大遗漏、内部一致**的研究覆盖。
  2. **不得**因为报告中出现“阶段性结论/当前判断/初步结论”等字样就认为可以结束讨论。
     结论的存在不是停止条件；停止只取决于“需求覆盖是否充分完备”。

# 评估依据（必须综合判断）
  你需要同时检查以下三者的一致性与覆盖度：
    - 最终研究方案（final_plan）
    - 当前研究报告（current_report）
    - 本轮讨论内容（round_discussion）

# 完备度检查清单（内部思考用，不要输出）
  1. 需求覆盖：
     - 用户需求中的目标、范围、关键问题是否都被逐项回应。
  2. 关键维度是否齐备：
     - 场景/对象/边界/假设/适用条件/限制因素/风险点等是否存在明显空白。
  3. 方案-报告一致性：
     - 当前报告是否严格沿最终研究方案的方向与范围展开。
  4. 论证闭合度：
     - 是否仍存在影响结论可靠性的关键事实缺口或逻辑断裂。
  5. 讨论增量价值：
     - 下一轮讨论是否仍**可能**补足“高影响、需求相关”的缺口。
       若仍可能补足，则不应结束。

# 判定规则
  1. 只有当你认为：
     - 用户需求的关键问题已被覆盖；
     - 关键维度与约束条件无明显遗漏；
     - 报告与方案逻辑一致；
     - 讨论中不存在影响结论可靠性的重大空白或矛盾；
     才可判定 can_stop = True。
  2. 只要存在任何“高影响、需求相关”的未覆盖点或明显不一致，
     即便已有阶段性结论，也必须判定 can_stop = False。

# 输出格式
  - 输出为JSON对象格式，示例如下(以下仅为示例)：
    ```json
      {{
         "can_stop":False
      }}
    ``` 
  - "can_stop"：布尔值，是否可结束讨论。
  - 不要输出理由、不要输出建议、不要输出下一轮关注点。
"""

    user_prompt = f"""
# 用户需求原文
```
{content}
```

# 基础知识（用于理解需求）
```
{knowledge}
```

# 最终研究方案
```
{final_plan}
```

# 当前研究报告
```
{current_report}
```

# 本轮讨论内容
```
{round_discussion}
```
"""
    answer, _, _, _ = qwen_model.do_call(system_prompt, user_prompt, no_search=False)
    answer = answer.strip()

    start_index = answer.find("{")
    end_index = answer.rfind("}")
    if start_index != -1 and end_index != -1:
        answer = answer[start_index : end_index + 1]
    else:
        raise ValueError("无法从回答中提取JSON对象")

    data = json.loads(answer)
    can_stop = bool(data.get("can_stop"))

    return can_stop


def create_roles(qwen_model: QwenModel, content, knowledges, stream=None):
    """根据用户需求生成研究员角色（性格 + 思维特长，通用化表述）。"""
    
    system_prompt = f"""
你正在组织一次多智能体理论研究讨论，需要生成固定数量（{ROLE_COUNT} 位）的研究员角色，
用于后续多轮推理和观点碰撞。

## 基本信息
- 当前日期：{now_date}
- 讨论模式：仅限理论研究与分析推理。
- 禁止在任何角色设定中假定开展或参与实验、测试、运行代码、操作系统、部署或现实业务活动。

## 角色设计原则
1. 所有角色的共同目标是：从不同思路出发，帮助更好地理解并解决当前用户需求。
2. 整体角色集合在视角和方法上应尽量形成互补：
   - 在问题理解方式、关注重点、推理习惯等方面存在差异；
   - 避免产生一组思维方式高度类似、只会重复的角色。
3. 每个角色通过“性格特征”和“思维特长”的组合来区分：
   - 性格特征体现其稳定的思考方式和沟通风格；
   - 思维特长体现其在推理、分析或整合方面相对突出的能力。
4. 思维特长需要有助于解决用户需求，但应保持为抽象的能力维度，不得是具体行业技能或岗位职能。
5. 严禁使用职业、职称、学科、研究方向、行业标签等描述角色，不得出现任何岗位称谓。
6. 所有角色的职责都以思考、分析、论证、评估、解释为核心，不围绕现实世界中的执行行为设定。
7. 可以参考提供的知识库理解背景，但不得把其中已有结论写成角色的预设立场或偏见。
8. 所有角色都应在“当前尚无最终结论”的前提下被设计，不预设任何固定答案或路线选择。

## 关于 personality 字段的约束
1. personality 只描述角色的性格特征和思维特长，使用通用语言，不绑定任何具体领域或问题场景。
2. personality 不得包含用户需求或参考资料中的专有名词、产品名称、格式名称、系统名称、算法名称等任务特定术语。
3. personality 不得描述与当前任务中具体对象、方案、路径相关的细节情景，不出现“在分析某对象时会怎样”这类表述。
4. personality 不得包含对当前任务中任何方案、路径或结论的评价、倾向或判断，不得暗含“已经更偏好某条路线”。
5. personality 中的思维特长应体现为稳定的认知能力和处理问题的方式，例如是否更偏向结构化、抽象化、整合、多角度对比、关注前提条件等，
   但不需要也不允许引用具体任务内容。
6. 性格与思维特长应同时满足：
   - 有能力把研究细节向更深层推进；
   - 有能力推动讨论继续向前发展；
   - 能保持一定的谨慎，关注容易被忽略的风险和前提条件；
   - 保留开放性和创造力，为后续讨论留出新的角度。

## 输出格式
- 只输出 JSON 数组，长度固定为 {ROLE_COUNT}，不得添加任何额外说明文字。
- 数组中每个元素必须是一个对象，字段严格限定为：
  - "role_name"：姓名（虚构、中文语境即可）。
  - "personality"：性格与思维特长的综合描述，使用一小段自然语言完成表述。
- "personality" 必须为通用表述，不得包含具体研究领域、技术路线、行业名称、岗位称谓或任务中特定名词。
"""

    user_prompt = f"""
# 用户需求
```
{content}
```

# 可选参考资料
```
{knowledges}
```
"""

    answer, reasoning, web_content_list, references = qwen_model.do_call(
        system_prompt, user_prompt, no_search=True
    )

    answer, reasoning, web_content_list, references = qwen_model.do_call(
        system_prompt, user_prompt, no_search=True
    )

    answer = answer.strip()
    start_index = answer.find("[")
    end_index = answer.rfind("]")

    if start_index != -1 and end_index != -1:
        answer = answer[start_index:end_index + 1]
    else:
        raise ValueError("无法从回答中提取JSON对象")

    data = json.loads(answer)

    for role in data:
        role["role_id"] = str(uuid.uuid4())
        role["role_job"] = ""  # 占位以兼容后续流程，不提供任何职业信息
        role["personality"] = role.get("personality", "")

    if stream:
        description = ""
        for role in data:
            description += (
                f"角色ID:{role['role_id']}\n"
                f"角色：{role['role_name']}\n"
                f"性格：{role['personality']}\n\n"
            )
        stream.process_chunk(f"角色：\n{description}\n")

    return data



def start_meeting(qwen_model: QwenModel, content, stream: AIStream = None):
    """整体会议流程入口。"""
    print("\n\n用户需求", content, "\n\n")

    print("\n====正在解读用户需求，构建基础知识库===\n")
    know_list, refs = create_webquestion_from_user(qwen_model, content, now_date)
    knowledge_content = rrange_knowledge(qwen_model, know_list, refs, now_date, content)
    print(knowledge_content)

    print("\n====基础知识库构建完成===\n")
    time.sleep(5)

    print("\n====初步方案构建====\n")
    research_plan = create_initial_solution(qwen_model, content, knowledge_content)
    research_report = ""

    print(research_plan)

    print("\n====初步方案构建完成====\n")

    print("\n====构建角色====\n")
    roles = create_roles(qwen_model, content, knowledge_content, stream=stream)
    print("\n====角色构建完成====\n")

    time.sleep(5)
    print("\n====开始讨论===\n")

    epcho = 1

    while epcho <= MAX_EPCHO:
        round_record = f"""
        [第{epcho}轮讨论开始]
        """
        print(f"\n====第{epcho}轮讨论开始===\n")

        for role_index, role in enumerate(roles):
            if stream:
                stream.process_chunk(
                    f"\n\n角色：{role['role_name']}\n性格和思维特长：{role['personality']}\n\n"
                )

            round_record, role_answer = role_dissucess(
                qwen_model,
                content,
                round_record,
                research_plan,
                research_report,
                now_date,
                role,
                knowledge_content,
                epcho,
                role_index,
                len(roles),
                MAX_EPCHO,
                stream,
            )

        print(f"\n\n====第{epcho}轮讨论结束，正在总结====\n\n")
        if epcho == 1:
            research_plan = summarize_and_consolidate_solutions(
                qwen_model, content, knowledge_content, research_plan, round_record, stream
            )
            print("\n\n====第一轮总结完成，已形成两个候选方案===\n\n" + research_plan + "\n")
        elif epcho == 2:
            print("\n====第二轮总结：生成最终研究方案===\n")
            research_plan = summarize_and_select_final_plan(
                qwen_model, content, knowledge_content, research_plan, round_record, stream
            )
            print(research_plan)
            print("\n====第二轮总结：生成初步研究报告===\n")
            research_report = generate_report_from_plan(qwen_model, content, knowledge_content, research_plan, stream)
            print(research_report)
        else:
            print(f"\n====第{epcho}轮总结：修订研究报告===\n")
            research_report = refine_report(
                qwen_model,
                content,
                knowledge_content,
                research_plan,
                research_report,
                round_record,
                stream,
            )
            print(research_report)
            print(f"\n====第{epcho}轮总结：判断是否可结束===\n")
            can_stop = evaluate_discussion_status(
                qwen_model,
                content,
                knowledge_content,
                research_plan,
                research_report,
                round_record,
                stream,
            )
            if can_stop:
                print("\n\n====当前讨论会议中止====\n\n")
                break
            else:
                print("\n\n====当前讨论会议继续====\n\n")

        epcho += 1

    print("\n\n====所有讨论已结束====\n\n")


    return research_report or research_plan
