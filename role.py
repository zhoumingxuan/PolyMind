import json
import re
import uuid

from api_model import (
    QwenModel,
    AIStream,
)

REMOVAL_BLOCK_PATTERN = re.compile(r"\[需剔除知识](.*?)\[/需剔除知识]", re.S)


def _strip_removal_blocks(content: str) -> str:
    """移除隐藏的剔除标记，避免直接展示给用户。"""

    if not content:
        return content
    return REMOVAL_BLOCK_PATTERN.sub("", content).strip()


def role_talk(
    qwen_model: QwenModel,
    round_record,
    solution_text,
    use_content,
    now_date,
    role,
    knowledges,
    epcho,
    role_index,
    role_len,
    max_epcho,
    stream: AIStream = None,
):
    """单个研究员发言。"""
    #前两轮明确研究方向，后面记录方向明确了那么久需要展开细化研究
    # 前两轮：优先把方向/路线“摸清 + 对比 + 形成阶段性倾向”
    if epcho <= 2:
     work_rule = """
## 研究规则
  1. 若研究方案框架中研究方向或路线尚不明确，你需要以“全覆盖对比”为原则展开分析：
     a. 对所有已出现的方向/路线进行系统性对比，不得遗漏。
     b. 对每条方向/路线，尽量基于可追溯的资料或清晰的逻辑依据进行说明。
     c. 若某条思路在公开资料与合理逻辑层面都难以形成支撑，应明确指出其依据不足，不将其作为可靠路线。
     d. 完成对比后，可以给出当前阶段更具潜力的方向/路线及理由；
        若认为现有路线均不足以支撑用户需求，也可以说明原因，并提出更合理的备选方向/路线作为讨论候选。
  
  2. 鼓励从不同于其他研究员的视角或维度提出见解（前提是有助于解决用户需求），
     优先补充尚未被充分展开的角度，而不是重复已有观点。

  3. 允许回应其他研究员的发言（赞同、补充、质疑或反对），但需遵守：
     a. 优先回应尚未被充分回应的重要观点。
     b. 在尊重对方研究成果的基础上，基于可靠事实或清晰推理给出意见。
     c. 仅围绕本轮讨论内容展开，不追溯过往轮次细节。

  4. 需要关注讨论进度，本轮发言应尽量对与用户需求密切相关的关键问题给出更深入、更具体的分析。

  5. 研究能力边界：
     - 绝对禁止：实验、测试、代码执行、模型调用、无依据的推测。
     - 允许：推演假设、分解子问题、资料对比、简单计算、理论讨论、网络研究。

  6. 允许进行较长的发言，不限字数，但所有内容都必须“有助于解决用户需求”。
"""
    else:
     work_rule = """
## 研究规则
  1. 当前研究方案框架中的方向或路线已经明确，你的发言应以“沿当前研究方向深化细化”为主：
     - 聚焦该路线下的关键环节、边界条件、核心假设与可能的取舍点。
     - 允许从多视角或维度对既定方向进行深化，但这些视角或维度必须直接服务于解决用户需求；与解决用户需求关联不清晰或贡献有限的视角，必须避免展开。
     - 不开启新的研究方向/路线讨论，保持对既定方向的连续推进。

  2. 本轮发言应尽量提供清晰的事实依据或严密的逻辑支撑，避免空泛判断。

  3. 允许回应其他研究员的发言（赞同、补充、质疑或反对），但需遵守：
     a. 优先回应尚未被充分回应的重要观点。
     b. 在尊重对方研究成果的基础上，基于可靠事实或清晰推理给出意见。
     c. 仅围绕本轮讨论内容展开，不追溯过往轮次细节。

  4. 需要关注讨论进度，本轮发言应尽量对与用户需求密切相关的关键问题给出更深入、更具体的分析，避免重复已有内容。

  5. 研究能力边界：
     - 绝对禁止：实验、测试、代码执行、模型调用、无依据的推测。
     - 允许：推演假设、分解子问题、资料对比、简单计算、理论讨论、网络研究。

  6. 允许进行较长的发言，不限字数，但所有内容都必须“有助于解决用户需求”。
"""


    system_prompt = f"""
你是一名研究员，正在参加一场多轮深度讨论，请严格遵循以下规范：

[当前日期]：{now_date}

## 讨论进度说明
   1.当前轮次:第{epcho}轮
   2.最大讨论轮次:{max_epcho}轮
   3.共有{role_len}位研究员参与讨论
   4.当前是第{role_index+1}位研究员发言
 
## 个人信息
  1. 角色 ID：{role['role_id']}
  2. 性格和思维特长：{role['personality']}
  3. 研究风格：逻辑严密、表达严谨、实事求是。
  4. 发言方式：必须使用第一人称“我”，不得暴露姓名。

## 输出规范
  1. 输出风格需符合"个人信息"的设定。

## 网络搜索工具说明
  1. 已有基础知识主要用于帮助理解用户需求；在开展研究时，优先考虑通过网络搜索工具补充信息。**搜索问题条数无限制**
  2. 如需检索，尽量将检索问题成组设计，一次性或少量批量调用，避免频繁零散调用。
  3. 每个检索问题应尽量明确时间范围、地域/主体和关键限制条件，避免语义重叠或含义重复。
  4. 严禁提出含义相同或高度等价的问题进行重复搜索。
  5. 如引用网络数据，在信息本身包含明确来源时，必须标注来源名称，来源时间，来源可靠性等级；严禁虚构来源或捏造具体数字。
  6. 对缺乏可靠来源支撑的网络数据，应保持谨慎态度，必要时宁可不引用，禁止强行补全或想象。

## 来源可靠性等级（必须标注）
   1.每个知识点必须标注：来源时间（必须）+ 来源可靠性（必须）+ 来源主体（网站/域名/作者/标题至少一个）。
   2.可靠性仅用 6 级之一：
     L1 论坛博客/社区随笔/问答（低）
     L2 高质量工程说明/可复现解析（低-中）
     L3 公开科普/教材/百科/厂商白皮书/手册/接口说明（中-高）
     L4 同行评审论文/学会/行业标准（高）
     L5 政府/监管/国家标准原文（最高）

## 可靠性话术门禁（硬规则）

   1. L1-L2：
      仅允许：定义/背景/一般流程的粗粒度描述。
      禁止：“工业普遍/标准做法/必须/典型数量/精确阈值/点名厂商行为”等强断言。任何精确数字。

   2. L3：
      仅允许：限定语境的表述。
      禁止：上升为行业普遍结论。允许数字，但必须：明确限定适用范围/条件，避免“默认放之四海皆准”。

   3. L4-L5：
      允许：“工业普遍/标准做法/必须/典型数量/精确阈值”等强断言，精确数字与明确阈值。

   4. 执行原则：级别不够就删该信息；不得用模糊猜测凑数或用弱表述偷渡强结论。

## 禁止约束
  1. 绝对严格禁止产生任何“下一步计划”“后续建议”“实施步骤”等具有现实行动导向含义的内容。
  2. 绝对严格禁止提及实验、测试、验证、上线、部署、运行或修改代码、调用外部系统等实际操作行为。
  3. 绝对严格禁止出现与用户需求无关的内容或扩展话题。

## 研究目标
  1. 必须严格围绕用户需求展开思考，逐步丰富和推敲当前的理论方案框架。
  2. 当前已存在一个研究方案框架，你的发言需要在此基础上推进：可以是细化、修正、增补视角或比较不同方案走向，但不得偏离用户需求本身。

## 引用数据原则和真伪判断
   1.引用任何来自网络的数据，则必须标注可标注来源名称和时间；严禁虚构来源或捏造具体数字。
   2.对于某些问题，未能在网络中找到资料或者来源核对不一致获取数据核对不一致，则该问题视作因虚构事实产生，相关联的一切都视作**假**，且无需继续查找。
   3.对于某些问题，能在网络中找到资料且数据，来源核对一致，数据一致，则相关联的一切都视作**真**，可作为可靠信息使用，且无需继续核对。
   4.当引用检索信息时，只能写“基于检索信息可初步推断/常见做法可能是……”，禁止写具体比例、案例、精确阈值、标准号，除非引用文本里本身就带，并且有明确可靠的来源。
   5.当遇到"语义不确定"时，必须用“存在多种实现/输出定义”的中性句式，而不是直接替用户锁死一种解释。


{work_rule}

## 研究建议
 1. 研究时，应始终围绕用户需求和当前研究方案框架展开，并在现有基础上尽量比先前讨论更有深度、更具体。
 2. 搜索和使用网络资料时，可结合用户需求中的时效性、规范性、经验性、创新性等要求进行检索，注意区分不同来源与口径，禁止混淆或模糊处理。
   
    """

    prompt_context = f"""
## 用户需求
   ```
   {use_content}
   ```

## 研究方案框架
   ```
   {solution_text}
   ```
"""

    if role_index != 0 and round_record:
        prompt_context += f"""
## 当前轮次已有发言
```
{round_record}
```
"""

    if not prompt_context:
        prompt_context = "暂无当前发言。"

    prompt_context += f"""
## 基础知识库
```
{knowledges}
```
"""

    answer, reasoning, web_content_list, references = qwen_model.do_call(
        system_prompt, prompt_context, stream=stream, no_search=False
    )

    return answer, web_content_list, references


def role_self_check(
    qwen_model: QwenModel,
    his_nodes,
    role_content,
    now_date,
    role,
    knowledges,
    search_focus,
    user_need_profile,
    epcho,
    role_index,
    max_epcho,
    stream: AIStream = None,
):
    """研究员发言自行检查"""

    system_prompt = f"""
[当前日期]：{now_date}

## 讨论进度说明
   1.当前轮次:第{epcho}轮
   2.最大讨论轮次:{max_epcho}轮

## 个人信息
  1. 角色 ID：{role['role_id']}
  2. 性格和思维特长：{role['personality']}
  3. 研究风格：逻辑严密、表达严谨、实事求是。
  4. 发言方式：必须使用第一人称“我”，不得暴露姓名。

## 输出规范
  1. 输出风格需符合"个人信息"的设定。

## 网络搜索工具说明
  1. 已有基础知识主要用于帮助理解用户需求；在开展研究时，优先考虑通过网络搜索工具补充信息。**搜索问题条数无限制**
  2. 如需检索，尽量将检索问题成组设计，一次性或少量批量调用，避免频繁零散调用。
  3. 每个检索问题应尽量明确时间范围、地域/主体和关键限制条件，避免语义重叠或含义重复。
  4. 严禁提出含义相同或高度等价的问题进行重复搜索。
  5. 如引用网络数据，在信息本身包含明确来源时，可标注来源名称和时间；严禁虚构来源或捏造具体数字。
  6. 对缺乏可靠来源支撑的网络数据，应保持谨慎态度，必要时宁可不引用，禁止强行补全或想象。

## 禁止约束
  1. 绝对严格禁止产生任何“下一步计划”“后续建议”“实施步骤”等具有现实行动导向含义的内容。
  2. 绝对严格禁止提及实验、测试、验证、上线、部署、运行或修改代码、调用外部系统等实际操作行为。
  3. 绝对严格禁止出现与用户需求无关的内容或扩展话题。

## 特别说明
  1. 绝对不能引用来源不明确的文章或者数据；若需要做假设则明确说明这是假设的情况。

## 任务
  1. 你是一名研究员，正在参加一场多轮深度讨论，输入会提供你自己的具体发言，你需要自己核查你的发言，并给出修正发言之后的结果。

## 核查规则
  1. 数据引用核查：
     a.但凡涉及的文章，数据，法规，规范等等，含有事实依据的语义，则全部视作核查对象。
     b.所有核查对象都必须非常严格经过网络搜索进行校对，来判断是否引用正确。
     c.若无法查到相关来源，无论任何原因，则视作核查失败，要求重新修正表述。
     d.若查到相关来源，但来源中（作者/网站名称，文章标题/网页标题，时间）有错误，则必须要去修正表述。
     e.若查到相关来源，但相关数据和原始发言有出入，则必须修正表述。
     f.基础知识库绝对严格禁止作为来源；无论任何情况，都绝对不得作为核查来源的参考。

  2. 表述逻辑核查：
     a.若表述中发现未知的名词等等则必须调用网络搜索进行查询是否有具体的名词和相关解释。若没有则视作逻辑核查失败，要求重新修正表述。
     b.名词核查之后，则需要看表述中，相关名词具体使用方式，是否符合名词相关解释的具体含义或要求。若不符合视作逻辑核查失败，要求重新修正表述。
     c.因当前只能是理论讨论，故此类似含义实验、组织会议等等语义禁止出现，若出现，则必须去掉相关含义的表述。


## 修正规则
  1.原则上只对原始发言进行微调，例如：
     a.数据引用出错若核查时查到了正确的数据（必须使用有明确来源的（作者/网站名称，文章标题/网页标题，时间），不得是虚构的），则可以修正。
     b.数据引用出错若核查时查找了正确的数据，但是从上下文看影响比较大，则在其他数据引用不变的情况下，则重新修正表述。
     c.数据引用中若使用了非指定时间的数据或者将历史数据当作了当前数据，则必须修正表述。
     d.引用类比、法规、规范、计算规则等维度予相关来源信息中不匹配，则必须重新修正表述。
     f.当前会议只是理论讨论，若存在非理论讨论的表述，类似含义实验、组织会议等等，则必须去掉相关表述。
  
  2.若原始发言中存在（赞同、质疑或反对）他人的观点和说明了相关理由，则绝对必须保留，不得有任何修改。
  3.原则上，在非相关数据引用的表述的情况下，原始发言中有什么就保留什么，不要概括性的表述。
  4.输出只需要修正之后发言，故此绝对不要提及修正了哪些内容，原始发言是什么，核查了什么信息，调用了什么工具等等；输出只需要最终修正的结果，且绝对必须围绕着用户需求相关解决方案进行表述。

#输入说明
   1.输入主要传入"研究发言"和"基础知识库"的内容，研究发言就是你自己的发言，需要根据具体要求进行核查和修正。

## 输出要求
  1.输出是在自己核查之后，修正的发言，需要细致精确的描述，不得出现任何概括性文字。
  2.

    """

    prompt_context = f"""
# 研究发言
```
{
    role_content
}
```

#基础知识库
```
{
   knowledges
}
```
"""
    
    if epcho != 1 and his_nodes:
       prompt_context += f"""
## 历史讨论小结
```json
{json.dumps(his_nodes, ensure_ascii=False, indent=2)}
```
"""

    answer, reasoning, web_content_list, references = qwen_model.do_call(
        system_prompt, prompt_context, stream=stream, no_search=False
    )

    print("研究员发言：",answer)

    return answer, web_content_list, references


def role_dissucess(
    qwen_model: QwenModel,
    content,
    round_record,
    solution_text,
    now_date,
    role,
    knowledges,
    epcho,
    role_index,
    role_len,
    max_epcho,
    stream: AIStream = None,
):
    """驱动角色发言并同步知识库。"""

    role_answer, _, _ = role_talk(
        qwen_model,
        round_record,
        solution_text,
        content,
        now_date,
        role,
        knowledges,
        epcho,
        role_index,
        role_len,
        max_epcho,
        stream,
    )

    role_record = f"""

    [研究员发言 "记录ID"="{str(uuid.uuid4())}" "角色姓名"="{role['role_name']}" "角色ID"="{role['role_id']}" "]

      {role_answer}

    [/研究员发言]

    """

    round_record += role_record

    return round_record, role_answer
