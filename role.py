import json
import uuid

from api_model import (
    QwenModel,
    AIStream,
)

def role_talk(
    qwen_model: QwenModel,
    round_record,
    solution_text,
    current_report,
    use_content,
    now_date,
    role,
    knowledges,
    epcho,
    role_index,
    role_len,
    max_epcho,
    stream: AIStream = None,
):
    """单个研究员发言。"""
    #前两轮明确研究方向，后面记录方向明确了那么久需要展开细化研究
    # 前两轮：优先把方向/路线“摸清 + 对比 + 形成阶段性倾向”
    if epcho == 1:
     work_rule = """
## 研究目标
  1. **必须严格按照用户需求展开深度思考**，逐步丰富和推敲当前的理论方案框架。
  2. 当前已存在一个研究方案，你的发言需要在此基础上推进：可以是细化、修正、增补视角或比较不同方案走向，但不得偏离用户需求本身。

## 研究规则
  1. 若研究方案中研究方向或路线尚不明确，你需要以“全覆盖对比”为原则展开分析：
     a. 必须立刻执行网络搜索查找相关资料，对所有已出现的方向/路线进行系统性对比，不得遗漏。
     b. 对每条方向/路线，基于可追溯的资料或清晰的逻辑依据进行说明。
     c. 若某条思路在公开资料与合理逻辑层面都难以形成支撑，应明确指出其依据不足，不能其作为可靠路线。
     d. 完成对比后，可以给出当前阶段更具潜力的方向/路线及理由；
        若认为现有路线均不足以支撑用户需求，也可以说明原因，并提出更合理的备选方向/路线作为讨论候选。
  
  2. 鼓励从不同于其他研究员的视角或维度提出见解（前提是有助于解决用户需求），
     优先补充尚未被充分展开的角度，而不是重复已有观点。

  3. 允许回应其他研究员的发言（赞同、补充、质疑或反对），但需遵守：
     a. 优先回应尚未被充分回应的重要观点。
     b. 在尊重对方研究成果的基础上，基于可靠事实或清晰推理给出意见。
     c. 仅围绕本轮讨论内容展开，不追溯过往轮次细节。

  4. 需要关注讨论进度，本轮发言应尽量对与用户需求密切相关的关键问题给出更深入、更具体的分析。

  5. 研究能力边界：
     - 绝对禁止：实验、测试、代码执行、模型调用、无依据的推测。
     - 允许：推演假设、分解子问题、资料对比、简单计算、理论讨论、网络研究。

  6. 允许进行较长的发言，不限字数，但所有内容都必须“有助于解决用户需求”。
"""
    elif epcho ==2 :
     work_rule = """
## 研究目标
  1. 基于第一轮已形成的**两种候选理论研究方案**，围绕用户需求进行“对比—核验—修订—收敛”，
     **推动第二轮讨论产出一个最终研究方案**。
  2. 你的发言必须直接服务于最终方案成形：可对两方案进行细化、修正、补强证据、明确边界条件、
     指出关键取舍依据，但**不得偏离**用户需求。

## 研究规则
  1. 围绕两种候选方案进行结构化对照与收敛：
     a. 必须立刻执行网络搜索查找相关资料，对两种方案进行系统性对比，确保不遗漏关键差异点。
     b. 对存在分歧、证据薄弱或逻辑跳跃的关键要点，**必须立刻执行网络搜索**进行核验与补强。
     c. 完成两种方案对比之后，**必须给出明确收敛结论**：
        - 说明你支持的**最终单一方案版本**及理由。
        - 判断两方案中是否存在**可保留的优点与可行融合方式**，若存在，请给出融合后方案的关键结构与核心论据。
  
  2. 鼓励从不同于其他研究员的视角或维度提出见解（前提是有助于解决用户需求），
     优先补充尚未被充分展开的角度，而不是重复已有观点。

  3. 允许回应其他研究员的发言（赞同、补充、质疑或反对），但需遵守：
     a. 优先回应尚未被充分回应的重要观点。
     b. 在尊重对方研究成果的基础上，基于可靠事实或清晰推理给出意见。
     c. 仅围绕本轮讨论内容展开，不追溯过往轮次细节。

  4. 需要关注讨论进度，本轮发言应尽量对与用户需求密切相关的关键问题，给出更深入、更具体的分析，并**显式推动方案收敛**。

  5. 研究能力边界：
     - 绝对禁止：实验、测试、代码执行、模型调用、无依据的推测。
     - 允许：推演假设、分解子问题、资料对比、简单计算、理论讨论、网络研究。

  6. 允许进行较长的发言，不限字数，但所有内容都必须“有助于解决用户需求”。
"""
    else:
     work_rule = """
## 研究目标
  1. 以“研究方案”为主线，对“当前研究报告”进行细化、补充与表述优化，让报告更完整、更全面、更具可行性与解释力。
  2. 所有新增内容必须服务于对“研究方案”的说明与支撑，禁止引入新的研究方向或替代性路线。

## 研究规则
  1. **范围锁定**：
     a. 仅在"研究方案"既定方向内展开，禁止开启新方向、替换主线或引入无关设想。
     b. 若发现报告内容与方案不一致或存在漂移，
        必须明确指出并给出**删除/改写/降级处理**的理由。

  2. **逐节对齐与增强**：
     a. 你的发言应尽量明确对应的报告章节或段落主题，
        并说明该处需要补强的论据、假设、边界条件或叙述结构。

     b. 在不改变“研究方案”主线的前提下：
        - 对关键主张进行必要的阐释与补强。
        - 确保对用户需求涉及的关键维度覆盖充分（如场景、视角、适用条件等）。
        - 避免出现“只有结论、缺乏解释链”的表述。

  3. **证据优先与检索硬约束**：
     a. 报告的新增、修订与补强必须以网络检索为前提，
        需先通过检索明确相关事实、定义、背景或常见做法，再据此进行报告修订。

     b. 对无法在公开资料或清晰逻辑中获得支撑的要点，
        不得虚构、捏造或想象补全；
        必要时应选择保留空缺、弱化表述或删除。
     
     c. 禁止将检索信息扩展为新的方案路线。

  4. **讨论内聚**：
     a. 允许回应其他研究员的发言（赞同、补充、质疑或反对），
        但回应必须落点于“如何改进报告与方案一致性”。
     b. 优先处理尚未被充分回应的关键修订点，避免重复陈述。

  5. **表达要求**：
     a. 本轮发言应以“**报告可直接吸收的表述**”为导向，
        尽量提供更清晰的定义、分点结构、逻辑顺序或对照框架。
     b. 所有补充必须有助于解决用户需求，且不得引入现实行动导向内容。

  6. **章节补全（允许新增）**：
     a. 允许在**基于网络检索明确事实**的前提下，
        对报告进行必要的章节补全或新增。
     b. 新增章节需说明其**具体主题、覆盖内容与必要性**，
        并明确其与“研究方案”和“用户需求”的对应关系。
"""


    system_prompt = f"""
你是一名研究员，正在参加一场多轮深度讨论，请严格遵循以下规范：

[当前日期]：{now_date}
[模式]:深度研究模式

## 讨论进度说明
   1.当前轮次:第{epcho}轮
   2.最大讨论轮次:{max_epcho}轮
   3.共有{role_len}位研究员参与讨论
   4.当前是第{role_index+1}位研究员发言
 
## 个人信息
  1. 角色 ID：{role['role_id']}
  2. 性格和思维特长：{role['personality']}
  3. 研究风格：逻辑严密、表达严谨、实事求是。
  4. 发言方式：必须使用第一人称“我”，不得暴露姓名。

## 输出规范
  1. 输出风格需符合"个人信息"的设定。

## 网络搜索工具说明
  1. 已有基础知识主要用于帮助理解用户需求；在开展研究时，优先考虑通过网络搜索工具补充信息。**搜索问题条数无限制**
  2. 如需检索，尽量以“问题组”的形式进行设计。为支持更深入的研究，特别允许在首次检索后继续进行第二次、第三次及更多轮检索，但后续检索的问题必须在前一次网络检索基础上进一步细化、深化或缩小范围，不得重复或泛化。
  3. 每个检索问题应尽量明确时间范围、地域/主体和关键限制条件，避免语义重叠或含义重复。
  4. 严禁提出含义相同或高度等价的问题进行重复搜索。
  5. 如引用网络数据，在信息本身包含明确来源时，必须标注来源名称，来源时间；严禁虚构来源或捏造具体数字。
  6. 对缺乏可靠来源支撑的网络数据，应保持谨慎态度，必要时宁可不引用，禁止强行补全或想象。

## 禁止约束
  1. 绝对严格禁止产生任何“下一步计划”“后续建议”“实施步骤”等具有现实行动导向含义的内容。
  2. 绝对严格禁止提及实验、测试、验证、上线、部署、运行或修改代码、调用外部系统等实际操作行为。
  3. 绝对严格禁止出现与用户需求无关的内容或扩展话题。

## 研究局限性约束
  1. 本次讨论仅允许基于**公开网络资料**与**理论分析推理**展开。
  2. 在所有表述中，均视为**无法开展或调用**任何现实能力与外部资源，
     包括但不限于：
     - 任何形式的模型调用（含大模型推理服务）
     - 训练/微调/蒸馏/评测对比
     - 代码执行、工具链运行、系统接入
     - 数据采集、现场验证或真实环境测试
  3. 因此，禁止在发言中写出**依赖上述能力才能成立**的方案细节或结论。
     若相关内容对论证结构必不可少，
     只能以**理论假设、概念框架或待讨论前提**的中性方式简要描述，
     不得将其写成已可验证、已可对比或可直接采用的论据。

## 引用数据原则和真伪判断
   1.引用任何来自网络的数据，则必须标注可标注来源名称和时间；严禁虚构来源或捏造具体数字。
   2.对于某些问题，未能在网络中找到资料或者来源核对不一致获取数据核对不一致，则该问题视作因虚构事实产生，相关联的一切都视作**假**，且无需继续查找。
   3.对于某些问题，能在网络中找到资料且数据，来源核对一致，数据一致，则相关联的一切都视作**真**，可作为可靠信息使用，且无需继续核对。
   4.当引用检索信息时，只能写“基于检索信息可初步推断/常见做法可能是……”，禁止写具体比例、案例、精确阈值、标准号，除非引用文本里本身就带，并且有明确可靠的来源。
   5.当遇到"语义不确定"时，必须用“存在多种实现/输出定义”的中性句式，而不是直接替用户锁死一种解释。


{work_rule}

## 研究建议
 1. 研究时，应始终围绕用户需求和当前研究方案展开，并在现有基础上尽量比先前讨论更有深度、更具体。
 2. 搜索和使用网络资料时，可结合用户需求中的时效性、规范性、经验性、创新性等要求进行检索，注意区分不同来源与口径，禁止混淆或模糊处理。

## 特别说明（非常重要）
 1. 来源只能在"相关引用"中能够查找到**真实存在**的条目。
 2. 禁止自行写网站名/作者/标题/日期等自由文本来源信息。
    这些信息只允许在你看到的原条目中**原样复制**。
 3. 当资料不足以给出某个细节时，宁可不写，也不要猜测或用模糊语气填充。
    """

    prompt_context = f"""
## 用户需求
   ```
   {use_content}
   ```

## 研究方案
   ```
   {solution_text}
   ```
"""

    if epcho >= 3 and current_report:
        prompt_context += f"""
## 当前研究报告
```
{current_report}
```
"""

    if role_index != 0 and round_record:
        prompt_context += f"""
## 当前轮次已有发言
```
{round_record}
```
"""

    if not prompt_context:
        prompt_context = "暂无当前发言。"

    prompt_context += f"""
## 基础知识库
```
{knowledges}
```
"""

    answer, reasoning, web_content_list, references = qwen_model.do_call(
        system_prompt, prompt_context, stream=stream, no_search=False
    )

    return answer, web_content_list, references


def role_dissucess(
    qwen_model: QwenModel,
    content,
    round_record,
    solution_text,
    current_report,
    now_date,
    role,
    knowledges,
    epcho,
    role_index,
    role_len,
    max_epcho,
    stream: AIStream = None,
):
    """驱动角色发言并同步知识库。"""

    role_answer, _, _ = role_talk(
        qwen_model,
        round_record,
        solution_text,
        current_report,
        content,
        now_date,
        role,
        knowledges,
        epcho,
        role_index,
        role_len,
        max_epcho,
        stream,
    )

    role_record = f"""

    [研究员发言 "记录ID"="{str(uuid.uuid4())}" "角色姓名"="{role['role_name']}" "角色ID"="{role['role_id']}" "]

      {role_answer}

    [/研究员发言]

    """

    round_record += role_record

    return round_record, role_answer
